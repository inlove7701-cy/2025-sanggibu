import streamlit as st
import google.generativeai as genai

# --- 1. í˜ì´ì§€ ì„¤ì • (Notion ìŠ¤íƒ€ì¼) ---
st.set_page_config(
    page_title="2025 ìƒê¸°ë¶€ ë©”ì´íŠ¸",
    page_icon="ğŸ“",
    layout="centered"
)

# CSSë¡œ í°íŠ¸, ì—¬ë°±, ìƒ‰ìƒ ì¡°ì • (ê¹”ë”í•œ í™”ì´íŠ¸ í†¤)
st.markdown("""
    <style>
    /* ì „ì²´ ë°°ê²½ ë° í°íŠ¸ ì„¤ì • */
    .main {
        background-color: #FFFFFF;
        font-family: 'Helvetica', 'Apple SD Gothic Neo', sans-serif;
    }
    /* ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
    .stTextArea textarea {
        background-color: #F7F9FB;
        border: 1px solid #E0E0E0;
        border-radius: 8px;
        font-size: 16px;
        line-height: 1.6;
    }
    /* í—¤ë” ìŠ¤íƒ€ì¼ */
    h1 {
        font-weight: 700;
        color: #333333;
        letter-spacing: -1px;
    }
    .subtitle {
        font-size: 16px;
        color: #888888;
        font-weight: 400;
        margin-top: -15px;
        margin-bottom: 30px;
    }
    /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .stButton button {
        background-color: #2E86C1;
        color: white;
        border-radius: 8px;
        font-weight: bold;
        padding: 0.5rem 1rem;
        border: none;
    }
    .stButton button:hover {
        background-color: #1B4F72;
    }
    </style>
    """, unsafe_allow_html=True)

# --- 2. API í‚¤ ì„¤ì • (Secretsì—ì„œ ê°€ì ¸ì˜¤ê¸°) ---
try:
    # Streamlit Cloudì˜ Secretsì— ì €ì¥ëœ í‚¤ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
    api_key = st.secrets["GOOGLE_API_KEY"]
except FileNotFoundError:
    # ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš© (Secretsê°€ ì—†ì„ ê²½ìš° ì—ëŸ¬ ë©”ì‹œì§€ ëŒ€ì‹  ì•ˆë‚´)
    api_key = None

# --- 3. í—¤ë” ì˜ì—­ ---
st.title("ğŸ“ 2025 ìƒê¸°ë¶€ ë©”ì´íŠ¸")
st.markdown("<p class='subtitle'>Gift for 2025 1st Grade Teachers</p>", unsafe_allow_html=True)
st.divider()

# API í‚¤ê°€ ì—†ì„ ê²½ìš° ì…ë ¥ì°½ í‘œì‹œ (ë°°í¬ ì „ í…ŒìŠ¤íŠ¸ìš©)
if not api_key:
    with st.expander("ğŸ” ê´€ë¦¬ì ì„¤ì • (API Key ì…ë ¥)"):
        api_key = st.text_input("Google API Key", type="password", help="Google AI Studioì—ì„œ ë°œê¸‰ë°›ì€ í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")

# --- 4. ì…ë ¥ ì˜ì—­ (Input) ---
st.markdown("### 1. í•™ìƒ ê´€ì°° ë‚´ìš©")
student_input = st.text_area(
    "í•™ìƒì˜ ì—í”¼ì†Œë“œ, íŠ¹ì§•, ì„±ê²© ë“±ì„ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”.",
    height=250,
    placeholder="ì˜ˆì‹œ:\n- ìˆ˜í•™ ì„±ì ì€ 4ë“±ê¸‰ì´ì§€ë§Œ ìˆ˜ì—… ì‹œê°„ì— ì§ˆë¬¸ì„ ì œì¼ ë§ì´ í•¨.\n- ì²´ìœ¡ëŒ€íšŒ ë•Œ ë°˜í‹° ë””ìì¸ ë¬¸ì œë¡œ ì¹œêµ¬ë“¤ì´ ì‹¸ìš¸ ë•Œ ì¤‘ì¬í•´ì„œ í•´ê²°í•¨.\n- ì§€ê°ì´ ì¦ì•˜ìœ¼ë‚˜ ìƒë‹´ í›„ ì•ŒëŒì„ 3ê°œ ë§ì¶”ê³  2í•™ê¸°ì—” ê°œê·¼í•¨.\n- ê¸‰ì‹ ë‹¹ë²ˆì„ ì•„ë¬´ë„ ì•ˆ í•˜ë ¤ í•  ë•Œ ë¨¼ì € ì†ë“¤ê³  í•¨."
)

# --- 5. í•„í„° ë° ì˜µì…˜ ì˜ì—­ (Filter) ---
st.markdown("### 2. ê°•ì¡°í•  í•µì‹¬ í‚¤ì›Œë“œ ì„ íƒ")
st.caption("ê°•ì¡°í•˜ê³  ì‹¶ì€ ì˜ì—­ì„ ì„ íƒí•˜ì„¸ìš”. (ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥ / ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ AIê°€ ìë™ìœ¼ë¡œ íŒë‹¨í•©ë‹ˆë‹¤)")

# 7ëŒ€ ì˜ì—­ + ìë™ íŒë‹¨ ì˜µì…˜ ì •ì˜
filter_options = [
    "ğŸ‘‘ AI ì…í•™ì‚¬ì •ê´€ ìë™ íŒë‹¨ (ì¶”ì²œ)", 
    "ğŸ“˜ í•™ì—… ì—­ëŸ‰ (íƒêµ¬/ì‹¬í™”)", 
    "ğŸ¤ ê³µë™ì²´ ì—­ëŸ‰ (ë¦¬ë”ì‹­/í˜‘ë ¥)", 
    "ğŸš€ ì§„ë¡œ ì—­ëŸ‰ (ì „ê³µì í•©ì„±)", 
    "ğŸŒ± ë°œì „ ê°€ëŠ¥ì„± (ì„±ì¥/ê·¹ë³µ)", 
    "ğŸ¨ ì°½ì˜ì  ë¬¸ì œí•´ê²°ë ¥", 
    "ğŸ˜Š ì¸ì„±/ë‚˜ëˆ”/ë°°ë ¤", 
    "â° ì„±ì‹¤ì„±/ê·œì¹™ì¤€ìˆ˜"
]

# st.pillsëŠ” Streamlit 1.40.0 ì´ìƒì—ì„œ ì‘ë™í•˜ëŠ” ì•Œì•½ ëª¨ì–‘ ë²„íŠ¼ì…ë‹ˆë‹¤. (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)
selected_tags = st.pills(
    "í‚¤ì›Œë“œ ë²„íŠ¼",
    options=filter_options,
    selection_mode="multi",
    label_visibility="collapsed" # ë¼ë²¨ ìˆ¨ê¹€ (ê¹”ë”í•˜ê²Œ)
)

# --- 6. ì‹¤í–‰ ë° ê²°ê³¼ ì˜ì—­ (Action & Result) ---
st.markdown("") # ì—¬ë°±
if st.button("âœ¨ ìƒê¸°ë¶€ ë¬¸êµ¬ ìƒì„±í•˜ê¸°", type="primary", use_container_width=True):
    if not api_key:
        st.error("âš ï¸ API Keyê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
    elif not student_input:
        st.warning("âš ï¸ í•™ìƒ ê´€ì°° ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!")
    else:
        with st.spinner('AI ì…í•™ì‚¬ì •ê´€ì´ í•™ìƒì˜ ê°•ì ì„ ë¶„ì„í•˜ì—¬ ë¬¸ì¥ì„ ë‹¤ë“¬ê³  ìˆìŠµë‹ˆë‹¤...'):
            try:
                # êµ¬ê¸€ Gemini ì„¤ì •
                genai.configure(api_key=api_key)
                model = genai.GenerativeModel('gemini-1.5-flash')

                # --- [í•µì‹¬] ì…í•™ì‚¬ì •ê´€ í˜ë¥´ì†Œë‚˜ í”„ë¡¬í”„íŠ¸ ì„¤ê³„ ---
                
                # ì„ íƒëœ íƒœê·¸ ì •ë¦¬
                if not selected_tags:
                    tags_str = "íŠ¹ë³„íˆ ì§€ì •ëœ ì˜ì—­ ì—†ìŒ (ì „ì²´ì ì¸ ë§¥ë½ì—ì„œ ê°€ì¥ ìš°ìˆ˜í•œ ì—­ëŸ‰ì„ ìŠ¤ìŠ¤ë¡œ íŒë‹¨í•˜ì—¬ ì¶”ì¶œ)"
                else:
                    tags_str = ", ".join(selected_tags)

                system_prompt = f"""
                # Role (ì—­í• )
                ë‹¹ì‹ ì€ ëŒ€í•™ ì…í•™ì‚¬ì •ê´€ì˜ ê´€ì ì„ ì™„ë²½í•˜ê²Œ ê°–ì¶˜ ëŒ€í•œë¯¼êµ­ ê³ ë“±í•™êµì˜ ë² í…Œë‘ ë‹´ì„ êµì‚¬ì…ë‹ˆë‹¤.
                í•™ìƒì˜ 1ë…„ê°„ì˜ í–‰ë™íŠ¹ì„± ë° ì¢…í•©ì˜ê²¬ì„ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

                # Input Data (ì…ë ¥ ì •ë³´)
                1. í•™ìƒ ê´€ì°° ë‚´ìš©: {student_input}
                2. êµì‚¬ê°€ ê°•ì¡°í•˜ê³  ì‹¶ì€ ì˜ì—­: [{tags_str}]

                # Instruction (ì§€ì‹œ ì‚¬í•­)
                1. **ë¶„ì„ ë‹¨ê³„**: ì…ë ¥ëœ ê´€ì°° ë‚´ìš©(Facts)ì„ ë¶„ì„í•˜ì—¬ í•™ìƒì˜ ì ì¬ë ¥, ì¸ì„±, í•™ì—… íƒœë„ë¥¼ íŒŒì•…í•˜ì‹­ì‹œì˜¤.
                2. **ì„ ë³„ ë‹¨ê³„**: 
                   - ë§Œì•½ 'AI ì…í•™ì‚¬ì •ê´€ ìë™ íŒë‹¨'ì´ ì„ íƒë˜ì—ˆê±°ë‚˜ ì„ íƒëœ ì˜ì—­ì´ ì—†ë‹¤ë©´, ëŒ€í•™ ì…ì‹œì—ì„œ ê°€ì¥ ê¸ì •ì ìœ¼ë¡œ í‰ê°€ë°›ì„ ìˆ˜ ìˆëŠ” í¬ì¸íŠ¸(ìê¸°ì£¼ë„ì„±, ë¬¸ì œí•´ê²°ë ¥, ë³€í™”ì™€ ì„±ì¥ ë“±)ë¥¼ ìµœìš°ì„ ìœ¼ë¡œ ì„ ë³„í•˜ì‹­ì‹œì˜¤.
                   - íŠ¹ì • ì˜ì—­ì´ ì„ íƒë˜ì—ˆë‹¤ë©´, í•´ë‹¹ ì˜ì—­ê³¼ ê´€ë ¨ëœ ì—í”¼ì†Œë“œë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì„œìˆ í•˜ë˜, ì „ì²´ì ì¸ íë¦„ì´ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§€ë„ë¡ í•˜ì‹­ì‹œì˜¤.
                3. **ì‘ì„± ë‹¨ê³„**:
                   - ë¬¸ì²´: '~í•¨', '~ì„', '~ë³´ì„', '~í‰ê°€ë¨'ê³¼ ê°™ì€ ê°œì¡°ì‹ê³¼ ì„œìˆ í˜•ì„ ì ì ˆíˆ í˜¼ìš©í•˜ì—¬ ë‹¨ì •í•˜ê³  ì „ë¬¸ì ì¸ ì–´ì¡°ë¥¼ ìœ ì§€í•˜ì‹­ì‹œì˜¤.
                   - êµ¬ì¡°: [êµ¬ì²´ì  ì‚¬ë¡€(Fact)] -> [í•™ìƒì˜ í–‰ë™ ë° ê³¼ì •(Action)] -> [ë°°ìš°ê³  ëŠë‚€ ì /ì„±ì¥í•œ ì /êµì‚¬ì˜ í‰ê°€(Impact)]ì˜ íë¦„ì„ ë”°ë¥´ì‹­ì‹œì˜¤.
                   - ë¶„ëŸ‰: 500ì~800ì ë‚´ì™¸ì˜ ì˜ ì •ëˆëœ í•˜ë‚˜ì˜ ë¬¸ë‹¨ìœ¼ë¡œ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
                   - **ì£¼ì˜**: ì¶”ìƒì ì¸ ì¹­ì°¬(ì°©í•˜ë‹¤, ì„±ì‹¤í•˜ë‹¤)ë§Œ ë‚˜ì—´í•˜ì§€ ë§ê³ , ë°˜ë“œì‹œ ì…ë ¥ëœ ì—í”¼ì†Œë“œë¥¼ ê·¼ê±°ë¡œ ì œì‹œí•˜ì‹­ì‹œì˜¤. ì—†ëŠ” ì‚¬ì‹¤ì„ ì§€ì–´ë‚´ì§€ ë§ˆì‹­ì‹œì˜¤.

                # Output Format (ì¶œë ¥ ì˜ˆì‹œ)
                (ì„œë¡  ì—†ì´ ë°”ë¡œ ìƒê¸°ë¶€ ì…ë ¥ìš© í…ìŠ¤íŠ¸ë§Œ ì¶œë ¥)
                í‰ì†Œ íƒ€ì¸ì˜ ì˜ê²¬ì„ ê²½ì²­í•˜ê³ ... (ì¤‘ëµ) ... ì´ëŸ¬í•œ ê²½í—˜ì„ í†µí•´ ê³µë™ì²´ì˜ ê°€ì¹˜ë¥¼ ì‹¤í˜„í•˜ëŠ” ì¸ì¬ë¡œ ì„±ì¥í•¨.
                """
                
                # AI í˜¸ì¶œ
                response = model.generate_content(system_prompt)
                result_text = response.text

                # ê²°ê³¼ ì¶œë ¥
                st.success("ì‘ì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
                st.markdown("### ğŸ“‹ ìƒì„±ëœ ìƒê¸°ë¶€ ì´ˆì•ˆ")
                st.info("ì•„ë˜ ë‚´ìš©ì„ ë³µì‚¬í•˜ì—¬ ë‚˜ì´ìŠ¤(NEIS)ì— ë¶™ì—¬ë„£ê±°ë‚˜ ìˆ˜ì •í•˜ì—¬ ì‚¬ìš©í•˜ì„¸ìš”.")
                
                # í…ìŠ¤íŠ¸ ì˜ì—­ì— ê²°ê³¼ í‘œì‹œ (ë³µì‚¬í•˜ê¸° í¸í•˜ê²Œ)
                st.text_area("ê²°ê³¼", value=result_text, height=300)
                
                # ë‹¤ì‹œ ì“°ê¸° íŒ ì œê³µ
                with st.expander("ğŸ’¡ ê²°ê³¼ê°€ ë§ˆìŒì— ë“¤ì§€ ì•Šë‚˜ìš”?"):
                    st.markdown("""
                    - **ë‚´ìš©ì´ ë„ˆë¬´ ì§§ë‹¤ë©´?** : ì…ë ¥ì°½ì— ì—í”¼ì†Œë“œë¥¼ ì¡°ê¸ˆ ë” êµ¬ì²´ì ìœ¼ë¡œ(ìœ¡í•˜ì›ì¹™) ì ì–´ì£¼ì„¸ìš”.
                    - **íŠ¹ì • ë¶€ë¶„ì„ ê°•ì¡°í•˜ê³  ì‹¶ë‹¤ë©´?** : ìœ„ ë²„íŠ¼ì—ì„œ í•´ë‹¹ ì˜ì—­ë§Œ ì„ íƒí•´ì„œ ë‹¤ì‹œ ìƒì„±í•´ë³´ì„¸ìš”.
                    - **ë§íˆ¬ê°€ ì–´ìƒ‰í•˜ë‹¤ë©´?** : ì…ë ¥ì°½ ë§ˆì§€ë§‰ì— "ì¡°ê¸ˆ ë” ë¶€ë“œëŸ½ê²Œ ì¨ì¤˜"ë¼ê³  ë©”ëª¨ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”.
                    """)

            except Exception as e:
                st.error(f"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
                st.caption("ì¼ì‹œì ì¸ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ì´ê±°ë‚˜ API Key ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
                
